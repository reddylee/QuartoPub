---
title: "tidymodels_vote_prediction"
format: html
---

# ------------------------------------------

# é¡¹ç›®åç§°ï¼šé¢„æµ‹å—è®¿è€…æ˜¯å¦æŠ•ç¥¨

# æ¡†æ¶ï¼štidymodels

# ä½œè€…ï¼šChatGPTï¼ˆä¸ºæ”¿æ²»ç§‘å­¦å®¶å®šåˆ¶ï¼‰

# æ—¥æœŸï¼š2025

# ------------------------------------------

# ğŸš€ ç¬¬ä¸€æ­¥ï¼šåŠ è½½å¿…è¦çš„åŒ…

```{r}
library(tidymodels)
```

# ğŸ“‚ ç¬¬äºŒæ­¥ï¼šè¯»å–å¹¶æ£€æŸ¥æ•°æ®

```{r}
set.seed(42)

n <- 1000

age <- sample(18:80, n, replace = TRUE)
income <- round(rnorm(n, mean = 50000, sd = 15000))
education <- sample(c("High School", "College", "Graduate"), n, replace = TRUE, prob = c(0.4, 0.4, 0.2))
gender <- sample(c("Male", "Female"), n, replace = TRUE)

# ç®€å•é€»è¾‘ç”Ÿæˆ vote æ„æ„¿æ¦‚ç‡
vote_prob <- plogis(-4 + 0.03 * age + 0.00003 * income +
  ifelse(education == "Graduate", 0.5, 0) +
  ifelse(gender == "Female", 0.2, 0))

vote <- ifelse(runif(n) < vote_prob, "yes", "no")

survey <- data.frame(
  age = age,
  income = income,
  education = education,
  gender = gender,
  vote = vote
)

# ä¿å­˜ä¸º CSV æ–‡ä»¶
write.csv(survey, "survey.csv", row.names = FALSE)

cat("âœ… æ–‡ä»¶ survey.csv å·²ä¿å­˜åˆ°å½“å‰å·¥ä½œç›®å½•ã€‚\n")
```

```{r}
data <- read_csv("survey.csv") # è¯·ç¡®ä¿ survey.csv ä¸æœ¬è„šæœ¬åœ¨åŒä¸€ç›®å½•

glimpse(data)
```

# ------------------------------------------

# ğŸ§ª ç¬¬ä¸‰æ­¥ï¼šåˆ’åˆ†è®­ç»ƒé›†å’Œæµ‹è¯•é›†

```{r}
set.seed(123)
split <- initial_split(data, prop = 0.8, strata = vote)
train <- training(split)
test <- testing(split)
```

# ------------------------------------------

# ğŸ§¹ ç¬¬å››æ­¥ï¼šå®šä¹‰é¢„å¤„ç†æµç¨‹ï¼ˆrecipeï¼‰

```{r}
rec <- recipe(vote ~ age + income + education + gender, data = train) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_normalize(all_numeric_predictors())
```

# ------------------------------------------

# ğŸ” ç¬¬äº”æ­¥ï¼šå®šä¹‰æ¨¡å‹ï¼ˆé€»è¾‘å›å½’ï¼‰

```{r}
log_model <- logistic_reg() %>%
  set_engine("glm") %>%
  set_mode("classification")
```

# ------------------------------------------

# ğŸ› ï¸ ç¬¬å…­æ­¥ï¼šæ„å»º workflow å¹¶è®­ç»ƒæ¨¡å‹

```{r}
wf <- workflow() %>%
  add_recipe(rec) %>%
  add_model(log_model)

fit <- wf %>% fit(data = train)
```

# ------------------------------------------

# ğŸ§¾ ç¬¬ä¸ƒæ­¥ï¼šé¢„æµ‹ä¸è¯„ä¼°

```{r}
preds <- predict(fit, test, type = "prob") %>%
  bind_cols(predict(fit, test)) %>%
  bind_cols(test)

# å‡†ç¡®ç‡ä¸ ROC AUC
print(metrics(preds, truth = vote, estimate = .pred_class))
print(roc_auc(preds, truth = vote, .pred_yes))
```

# ------------------------------------------

# ğŸ“Š ç¬¬å…«æ­¥ï¼šç»˜åˆ¶æ··æ·†çŸ©é˜µ

```{r}
conf_mat(preds, truth = vote, estimate = .pred_class) %>%
  autoplot(type = "heatmap")
```

# ------------------------------------------

# ğŸ¯ é™„åŠ ç»ƒä¹ ï¼šæ›¿æ¢æ¨¡å‹ä¸ºå†³ç­–æ ‘

# tree_model \<- decision_tree() %\>%

# set_engine("rpart") %\>%

# set_mode("classification")

# wf_tree \<- wf %\>% update_model(tree_model)

# fit_tree \<- fit(wf_tree, data = train)

# ğŸ¯ é™„åŠ ç»ƒä¹ ï¼šäº¤å‰éªŒè¯ + ROC

# folds \<- vfold_cv(train, v = 5, strata = vote)

# fit_resample(wf, resamples = folds, metrics = metric_set(roc_auc))

# ------------------------------------------

# âœ… é¡¹ç›®å®Œæˆ

```{r}
cat("ğŸ‰ æ¨¡å‹æ„å»ºå®Œæˆï¼æ‚¨å¯ä»¥ç»§ç»­æ‰©å±•ç‰¹å¾æˆ–å°è¯•å…¶ä»–æ¨¡å‹ã€‚\n")
```
